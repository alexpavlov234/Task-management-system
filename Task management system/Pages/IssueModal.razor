@using Syncfusion.Blazor.Calendars
@using Syncfusion.Blazor.DropDowns
@using System.ComponentModel.DataAnnotations
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Navigations
@using Task_management_system.Areas.Identity
@using Task_management_system.Models
@using Task_management_system.Pages.Common
@using Task_management_system.Services.Common
@using Syncfusion.Blazor.Popups
@inject IProjectService ProjectService


<SfDialog Width="85%" Height="auto" IsModal="true" ShowCloseIcon="true" EnableResize="true" AllowDragging="true" @bind-Visible="@IsVisible">
    <DialogTemplates>
        <Header>
            @if (this.issue != null)
            {
                @if (this.issue.Project != null)
                {
                    <span style="color: darkgray;">@this.issue.Project.ProjectName / </span>
                    <span style="color: #009cfc;">@this.issue.Subject</span>
                }
                else
                {
                    <span style="color: #009cfc;">@this.issue.Subject</span>
                }
            }

        </Header>
        <Content>



            <hr class="@statusLineColor" />
            <EditForm EditContext="editContext">

                <DataAnnotationsValidator />


                <InputText id="issueName" @bind-Value="issue.Subject" class="form-control my-4" placeholder="Име" style="font-size: 36px"></InputText>
                <ValidationMessage For="@(() => issue.Subject)" />
                <div class="row">
                    <!-- Column 1 -->
                    <div class="col-md-6">
                        <div class="p-3 col-md-12" style="border: 1px solid lightgray; border-radius: 5px">
                            <div class="row py-1">
                                <div class="col-md-3 d-flex align-items-center">
                                    <i class="fa-solid fa-arrows-spin" style="color: dimgray"></i>&nbsp;&nbsp;<span style="color: dimgray;"><b>Статус</b></span> &nbsp;&nbsp;&nbsp;&nbsp;
                                </div>
                                <div class="col-md-9 d-flex align-items-center">

                                    <SfDropDownList @ref="statusDropDownList" ID="status" TValue="string" Enabled="true" TItem="KeyValue" @bind-Value="issue.Status" PopupHeight="350px" PopupWidth="350px" DataSource="@statuses">
                                        <DropDownListFieldSettings Value="Name" Text="Name"></DropDownListFieldSettings>
                                        <DropDownListEvents TItem="KeyValue" TValue="string" ValueChange="@OnValueSelectHandlerStatus"></DropDownListEvents>
                                    </SfDropDownList>

                                </div>

                            </div>
                            <div class="row py-1">
                                <div class="col-md-3 d-flex align-items-center">
                                    <i class="fa-solid fa-circle-exclamation" style="color: dimgray"></i>&nbsp;&nbsp;<span style="color: dimgray;"><b>Приоритет</b></span> &nbsp;&nbsp;&nbsp;&nbsp;
                                </div>
                                <div class="col-md-9 d-flex align-items-center">

                                    <SfDropDownList @ref="priorityDropDownList" ID="priority" TValue="string" Enabled="true" TItem="KeyValue" @bind-Value="issue.Priority" PopupHeight="350px" PopupWidth="350px" DataSource="@priorities">
                                        <DropDownListFieldSettings Value="Name" Text="Name"></DropDownListFieldSettings>
                                    </SfDropDownList>

                                </div>

                            </div>
                        </div>
                        <ValidationMessage For="@(() => issue.Priority)"/>
                    </div>
                    <!-- Column 2 -->
                    <div class="col-md-6">
                        <div class="p-3 col-md-12" style="border: 1px solid lightgray; border-radius: 5px">
                            <div class="row py-1">
                                <div class="col-md-3 d-flex align-items-center">
                                    <i class="fa-solid fa-clone fa-lg" style="color: dimgray"></i>&nbsp;&nbsp;<span style="color: dimgray;"><b>Проект</b></span> &nbsp;&nbsp;&nbsp;&nbsp;
                                </div>
                                <div class="col-md-9 d-flex align-items-center">
                                    <SfDropDownList ID="project" TValue="int" TItem="Project" @bind-Value="issue.ProjectId" PopupHeight="350px" PopupWidth="350px" Placeholder="Изберете проект" DataSource="@projects">
                                        <DropDownListFieldSettings Value="ProjectId" Text="ProjectName"></DropDownListFieldSettings>
                                        <DropDownListEvents TItem="Project" TValue="int" ValueChange="@OnValueSelectHandlerProject"></DropDownListEvents>
                                    </SfDropDownList>
                                </div>



                            </div>
                            <div class="row py-1">
                                <div class="col-md-3 d-flex align-items-center">
                                    <i class="fa-solid fa-clock fa-lg" style="color: dimgray"></i>&nbsp;&nbsp;<span style="color: dimgray;"><b>Срок</b></span> &nbsp;&nbsp;&nbsp;&nbsp;
                                </div>
                                <div class="col-md-9 d-flex align-items-center">
                                    <SfDateRangePicker ID="datepicker" TValue="DateTime" Format="dd.MM.yyyy" @bind-StartDate="@issue.StartTime" @bind-EndDate="@issue.EndTime" ShowTodayButton="true" ShowClearButton="true" Min="@MinDate"></SfDateRangePicker>
                                    <ValidationMessage For="@(() => issue.EndTime)"/>
                                    <ValidationMessage For="@(() => issue.StartTime)"/>
                                </div>
                            </div>
                        </div>
                        <ValidationMessage For="@(() => issue.Project)"/>
                    </div>
                </div>
                <label for="description">Описание на задача</label>
                <div class="multiline">
                    <SfTextBox id="description" Multiline=true Placeholder="Въведете описание на задача" @bind-Value="@issue.Description"></SfTextBox>
                    <ValidationMessage For="@(() => issue.Description)" />
                </div>
                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label for="owner">Възложена на</label>
                        <SfDropDownList ID="owner" TValue="ApplicationUser" TItem="ApplicationUser" @bind-Value="issue.AssignedТo" PopupHeight="350px" PopupWidth="350px" Placeholder="Изберете, на кого е възложена" DataSource="@users">
                            <DropDownListFieldSettings Value="UserName" Text="FullName"></DropDownListFieldSettings>
                        </SfDropDownList>
                        @*<SfDropDownList ID="owner" TValue="string" TItem="ApplicationUser" @bind-Value="issueAssignedToUserName" PopupHeight="350px" PopupWidth="350px" Placeholder="Изберете, на кого е възложена " DataSource="@users">
                        <DropDownListFieldSettings Value="UserName" Text="FullName"></DropDownListFieldSettings>
                        </SfDropDownList>*@
                        <ValidationMessage For="@(() => issue.AssignedТo)" />
                    </div>
                    @if (!this.IsIssueNew)
                    {
                        <SfTab>
                            <TabItems>
                                <TabItem>

                                    <ChildContent>
                                        <TabHeader Text="Подзадачи"></TabHeader>

                                    </ChildContent>
                                    <ContentTemplate>
                                        <nav class="navbar navbar-expand">
                                            <!-- Left navbar links -->
                                            <ul class="navbar-nav float">
                                                <li class="nav-item d-none d-sm-inline-block">
                                                    <button type="button" class="btn btn-primary btn-outline-primary waves-effect md-trigger" @onclick="AddSubtask">Новa подзадача</button>


                                                </li>
                                                <li class="nav-item d-none d-sm-inline-block">
                                                    &nbsp;
                                                </li>
                                            </ul>
                                        </nav>
                                        <SfGrid ID="subtasksGrid" DataSource="this.issue.Subtasks" AllowSorting="true" AllowFiltering="true" EnableAltRow="true" EnableHover="false"
                                                AllowTextWrap="true" @ref="subtasksGrid" AllowSelection="true"
                                                AllowPaging="true">
                                            <GridFilterSettings Type="Syncfusion.Blazor.Grids.FilterType.Excel"></GridFilterSettings>
                                            <GridPageSettings PageCount="5" PageSize=20 PageSizes="true"></GridPageSettings>

                                            <GridColumns>
                                                <GridColumn Width="40px">
                                                    <Template Context="context2">
                                                        <SfTooltip Position="Position.BottomCenter" Content="Редактиране" OpensOn="Hover">
                                                            <button type="button" class="btn btn-outline-warning waves-effect md-trigger" @onclick="(() => EditSubtask(context2 as Subtask))">
                                                                <i class="fa-solid fa-pen-to-square"></i>
                                                            </button>
                                                        </SfTooltip>
                                                    </Template>
                                                </GridColumn>
                                                <GridColumn Width="40px">
                                                    <Template Context="context2">
                                                        <SfTooltip Position="Position.BottomCenter" Content="Изтриване" OpensOn="Hover">
                                                            <button type="button" class="btn btn-outline-danger waves-effect md-trigger" @onclick="(() => DeleteSubtask(context2 as Subtask))">
                                                                <i class="fa-solid fa-trash"></i>
                                                            </button>
                                                        </SfTooltip>
                                                    </Template>
                                                </GridColumn>


                                                <GridColumn Field=@nameof(Subtask.Subject) HeaderText="Име" IsPrimaryKey="true" TextAlign="TextAlign.Right" Width="120"></GridColumn>
                                                <GridColumn Field=@nameof(Subtask.Status) HeaderText="Статус" Width="120"></GridColumn>
                                                <GridColumn Field=@nameof(Subtask.StartTime) HeaderText="Начална дата" Width="120"></GridColumn>
                                                <GridColumn Field=@nameof(Subtask.EndTime) HeaderText="Крайна дата" Width="120"></GridColumn>
                                            </GridColumns>
                                        </SfGrid>
                                    </ContentTemplate>
                                </TabItem>
                                <TabItem>
                                    <ChildContent>
                                        <TabHeader Text="Прикачени файлове"></TabHeader>
                                    </ChildContent>
                                    <ContentTemplate>
                                        <h1 class="m-3">В процес на разработка! 😊 </h1>
                                        </ContentTemplate>
                                </TabItem>
                            </TabItems>
                        </SfTab>
                    }
                    </div>


            </EditForm>
        </Content>
        <FooterTemplate>
            <div class="form-group">
                <div class="text-right">
                    <button type="button" class="btn btn-primary" @onclick="SaveIssue">Запиши</button>
                    <button type="button" class="btn btn-secondary" @onclick="CloseDialog">Отказ</button>
                </div>
            </div>
        </FooterTemplate>
    </DialogTemplates>
</SfDialog>
<ToastMsg @ref="toast" />
<SubtaskModal @ref="subtaskModal" CallbackAfterSubmit="UpdateAfterSubtaskModalSubmitAsync" />
<style>
    .e-dialog .e-dlg-content {
        font-family: SegoeUI;
    }
</style>